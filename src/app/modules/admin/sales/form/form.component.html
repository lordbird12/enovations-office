<div class="flex flex-col min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="sticky top-0 z-10 bg-white dark:bg-gray-800 shadow-sm">
        <div class="container mx-auto px-4 py-6 flex flex-col sm:flex-row items-center justify-between">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white truncate">
                {{ isForm ? 'สร้างใบจอง ' + (type ?? '-') : 'แก้ไขการจอง' }}
            </h2>
            <div>
                <button *ngIf="!isForm" class="px-6 py-2 ml-3 rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors" 
                        mat-flat-button color="warn" (click)="onBack()">
                    ย้อนกลับ
                </button>
            </div>
        </div>
    </div>
    <!-- Main Content -->
    <div class="flex-grow mx-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
            <form [formGroup]="formData">
                <!-- Two Column Layout for Form Sections -->
                <div class="grid grid-cols-1 lg:grid-cols-2">
                    <!-- Left Column -
                    <div class="space-y-6">
                        <!-- Booking Information Section -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                                ข้อมูลการจอง
                            </h3>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>เลขที่ใบยืม</mat-label>
                                    <input matInput placeholder="เลขที่ใบยืม" [formControlName]="'reserve_ref_no'">
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>วันทีจอง</mat-label>
                                    <mat-date-range-input [rangePicker]="picker">
                                        <input matStartDate placeholder="วันที่เริ่มต้น" formControlName="start_date">
                                        <input matEndDate placeholder="วันที่สิ้นสุด" formControlName="end_date">
                                    </mat-date-range-input>
                                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                                    <mat-date-range-picker #picker></mat-date-range-picker>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>วัตถุประสงค์การขอ</mat-label>
                                    <mat-select [formControlName]="'request_purpose'" placeholder="ระบุวัตถุประสงค์">
                                        <mat-option *ngFor="let item of purpose" [value]="item">
                                            {{item}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <div *ngIf="this.formData.value.request_purpose === 'Demo'">
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>งบประมาณ</mat-label>
                                        <input matInput placeholder="งบประมาณ" [formControlName]="'budget'">
                                    </mat-form-field>
                                </div>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Function Quatifications ที่หมอต้องการ</mat-label>
                                    <input matInput placeholder="Function Quatifications ที่หมอต้องการ"
                                        [formControlName]="'function_qualifications'">
                                </mat-form-field>

                                <div *ngIf="this.type === 'Echocardiogram'">
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>Work Station</mat-label>
                                        <input matInput placeholder="Work Station" [formControl]="workstationFilter"
                                            (click)="openDialogProduct('work')" readonly="">
                                    </mat-form-field>
                                </div>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>อุปกรณ์อื่นที่ต้องการ</mat-label>
                                    <input matInput placeholder="อุปกรณ์อื่นที่ต้องการ"
                                        [formControlName]="'additional_equipment'">
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>วัน เวลา สถานที่นัดหมาย</mat-label>
                                    <input matInput placeholder="อุปกรณ์อื่นที่ต้องการ"
                                        [formControlName]="'meeting_details'">
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Current Hospital Equipment Section -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                                ข้อมูลการใช้เครื่องปัจจุบันของโรงพยาบาล
                            </h3>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>รุ่นที่ใช้อยู่</mat-label>
                                    <input matInput placeholder="รุ่นที่ใช้อยู่"
                                        [formControlName]="'current_machine_model'">
                                </mat-form-field>

                                <div *ngIf="this.type === 'Echocardiogram'">
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>Work Station</mat-label>
                                        <input matInput placeholder="Work Station" [formControlName]="'current_work_station'">
                                    </mat-form-field>
                                </div>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>ปัญหาหรือความต้องการที่ใช้อยู่</mat-label>
                                    <input matInput placeholder="ปัญหาหรือความต้องการที่ใช้อยู่"
                                        [formControlName]="'current_usage_problem'">
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Competitor Information Section -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                                ข้อมูลการเครื่องคู่แข่งที่นำเสนอ
                            </h3>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>รุ่นที่นำเสนอ</mat-label>
                                    <input matInput placeholder="รุ่นที่นำเสนอ" [formControlName]="'competitor_model'">
                                </mat-form-field>

                                <div *ngIf="this.type === 'Echocardiogram' || this.type === 'Ultrasound Imaging' || this.type === 'rc'">
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>หัวตรวจ</mat-label>
                                        <input matInput placeholder="หัวตรวจ" [formControlName]="'competitor_transducer'">
                                    </mat-form-field>
                                </div>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Feedback ลูกค้า</mat-label>
                                    <input matInput placeholder="ปัญหาหรือความต้องการที่ใช้อยู่"
                                        [formControlName]="'customer_feedback'">
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Customer Information Section -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                                ข้อมูลลูกค้า
                            </h3>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>ชื่อโรงพยาบาล</mat-label>
                                    <input matInput [formControl]="clientFilter" [matAutocomplete]="clientAutoComplete"
                                        placeholder="ค้นหาโรงพยาบาล" />
                                    <mat-autocomplete #clientAutoComplete="matAutocomplete"
                                        (optionSelected)="onSelectClient( $event.option.value, 'manual')">
                                        <mat-option *ngFor="let item of filterClient | async" [value]="item.name">
                                            {{item.name}}
                                        </mat-option>
                                    </mat-autocomplete>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>ประเภทโรงพยาบาล</mat-label>
                                    <mat-select [formControlName]="'customer_type'" placeholder="">
                                        <mat-option *ngFor="let item of customerType" [value]="item">
                                            {{item}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>จังหวัด</mat-label>
                                    <mat-select [formControlName]="'province'" placeholder="">
                                        <mat-option *ngFor="let item of provinces" [value]="item">
                                            {{item}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>แผนก</mat-label>
                                    <mat-select [formControlName]="'department'" placeholder="">
                                        <mat-option *ngFor="let item of departments" [value]="item">
                                            {{item}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>ชั้น</mat-label>
                                    <input matInput placeholder="ชั้น" [formControlName]="'floor'">
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>แพทย์ KOL</mat-label>
                                    <input matInput placeholder="แพทย์ KOL" [formControlName]="'kol_doctor'">
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>ข้อมูลอื่น ๆ เพิ่มเติมที่ว่าจะช่วยให้ได้งาน</mat-label>
                                    <textarea matInput [placeholder]="''" [rows]="4"
                                        formControlName="additional_info"></textarea>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Machine Models Section -->
                <div class="mt-8 bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                        รายการเครื่องที่ต้องการ
                    </h3>
                    
                    <div formArrayName="machine_models">
                        <div *ngFor="let machine of machineModels.controls; let i = index" [formGroupName]="i"
                            class="flex items-center gap-4 mb-3 p-3 bg-white dark:bg-gray-600 rounded-md">
                            <mat-form-field appearance="outline" class="flex-grow">
                                <mat-label>รุ่นเครื่อง</mat-label>
                                <input matInput placeholder="Machine Model" formControlName="machine_model_name" readonly>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="w-24">
                                <mat-label>จำนวน</mat-label>
                                <input matInput type="number" formControlName="qty" min="1">
                            </mat-form-field>
                            <button mat-icon-button color="warn" (click)="removeMachineModel(i)" class="hover:bg-red-100 dark:hover:bg-red-900">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4 mt-4">
                        <mat-form-field appearance="outline" class="flex-grow">
                            <mat-label>ค้นหาเครื่อง</mat-label>
                            <input matInput [formControl]="machineModelFilter" [matAutocomplete]="item" placeholder="ค้นหาเครื่องที่ต้องการ" />
                            <mat-autocomplete #item="matAutocomplete" (optionSelected)="onSelectMachineModel($event, 'machine_models')">
                                <mat-option *ngFor="let item of filterMachineModel | async" [value]="item.name">
                                    <span>{{item.name}}</span>
                                </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                    </div>
                </div>

                <!-- Transducers Section -->
                <div class="mt-6 bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                        รายการหัวตรวจที่ต้องการ
                    </h3>
                    
                    <div formArrayName="transducers">
                        <div *ngFor="let transducer of transducers.controls; let i = index" [formGroupName]="i"
                            class="flex items-center gap-4 mb-3 p-3 bg-white dark:bg-gray-600 rounded-md">
                            <mat-form-field appearance="outline" class="flex-grow">
                                <mat-label>รุ่นหัวตรวจ</mat-label>
                                <input matInput placeholder="Transducer Model" formControlName="machine_model_name">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="w-24">
                                <mat-label>จำนวน</mat-label>
                                <input matInput type="number" formControlName="qty" min="1">
                            </mat-form-field>
                            <button mat-icon-button color="warn" (click)="removeTransducer(i)" class="hover:bg-red-100 dark:hover:bg-red-900">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4 mt-4">
                        <mat-form-field appearance="outline" class="flex-grow">
                            <mat-label>ค้นหารุ่นหัวตรวจ</mat-label>
                            <input matInput [formControl]="machineModelFilter" [matAutocomplete]="transducer" placeholder="ค้นหารุ่นหัวตรวจ" />
                            <mat-autocomplete #transducer="matAutocomplete" (optionSelected)="onSelectMachineModel($event, 'transducer')">
                                <mat-option *ngFor="let item of filterMachineModel | async" [value]="item.name">
                                    <span>{{item.name}}</span>
                                </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"
                            mat-flat-button [color]="'warn'" (click)="onBack()">
                        ยกเลิก
                    </button>
                    <button class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                            mat-flat-button [color]="'primary'" (click)="onSubmit()">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>